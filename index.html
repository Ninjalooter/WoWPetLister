<html>
	<head>
	<title>WoW Pet Lister - Ninjalooter</title>
		<script src="jquery.1.6.1.js"></script>
		<script src="jquery.cookie.js"></script>
		<script src="jquery.battlenet.wow.js"></script>
		<script src="pet_lister.ids.js"></script>
		
		<script>
			var gMountSpells, gPetSpells;
			var g_spells = [];
			var g_items = [];
		</script>
		<script src="pet_lister.companions.js"></script>
		<script>
			gPetSpells = g_spells; // Store globally
			
			// Reset g_spells
			g_spells = [];
		</script>
		<script src="pet_lister.mounts.de.js"></script>
		<script>
			gMountSpells = g_spells; // Store globally
		</script>
		
		
		
		<script>
			function filterSpellIdListe(aListe, spells) {
				var spells = jQuery.grep(spells, function(spell, spellId) {
					return spell && jQuery.inArray(spellId, aListe) == -1;
				});
				return spells;
			}
			
			function wowhead_spellicon(spell) {
				if ( spell.icon ) {
					return "http://static.wowhead.com/images/wow/icons/small/" + spell.icon + ".jpg";  
				}
				return "";
			}
			function wowhead_spellurl(spell) {
				return "http://de.wowhead.com/spell=" + spell;
			}
			
			jQuery.fn.pet_lister = function(playerSpellList, raceId, spellIdList) {
				return this.each(function() {
					var element = $(this);
					
					var spellText;
					
					if ( $("#list_id").val() == "companions" ) {
						spellText = "pets";
					} else {
						spellText = "mounts";
					}
					
					var missingSpells = filterSpellIdListe(playerSpellList, spellIdList);
					
					
					
					// Process all filters
					jQuery.each(gDecoratorAndFilters, function(index, value) { 
						if ( !value.filter_element_id )
							return;
						
						// Check if the filter is 'checked'
						if ( $(value.filter_element_id).prop("checked") ) {
							// Filter all ids from that list
							missingSpells = jQuery.grep(missingSpells, function(spell, index) {
								return jQuery.inArray(spell.id, value.ids) == -1;
							});
						}
					});
					// Process Faction Filters
					var charFaction = $.battlenet({'action':'get-faction-by-race', 'race':raceId});
					var factionSpellIds = charFaction == "ALLIANCE" ? gRaceAllianceIds : gRaceHordeIds;
					var otherFactionSpellIds = charFaction == "HORDE" ? gRaceAllianceIds : gRaceHordeIds;
					
					if ( $("#filter_ownfactionspells").prop("checked") ) {
						missingSpells = jQuery.grep(missingSpells, function(spell, index) {
							return jQuery.inArray(spell.id, factionSpellIds.ids) == -1;
						});
					}
					if ( $("#filter_otherfactionspells").prop("checked") ) {
						missingSpells = jQuery.grep(missingSpells, function(spell, index) {
							return jQuery.inArray(spell.id, otherFactionSpellIds.ids) == -1;
						});
					}
					
					
					// Prepare output list
					var table = $("<table></table>");
					if ( missingSpells.length == 0 ) {
						table.append("<tr><td>You have everything!</td></tr>");
					} else {
						jQuery.each(missingSpells, function(index, value) {
							var id = value.id;
							var name = value.name_dede;
							
							var tr = $("<tr></tr>");
							var spellIcon = wowhead_spellicon(value);
							if (spellIcon) {
								var img = $("<img />");
								img.attr("border", "0");
								img.attr("src", spellIcon);
								tr.append($("<td></td>").append(img));
							}
							
							tr.append($("<td><a href=\"" + wowhead_spellurl(id) + "\">" + name + "</a></td>"));
							
							jQuery.each(gDecoratorAndFilters, function(decorator_index, decorator) {
								if (!decorator.decorator_text)
									return;
								
								if ( jQuery.inArray(id, decorator.ids) >= 0 ) {
									tr.append($("<td>" + decorator.decorator_text + "</td>"));
								}
							});
							table.append(tr);
						});
					}
						
					
					element.empty();
					// resultList.append("You have " + playerSpellList.length + " " + spellText)
					element.append($("<h2>You have " + playerSpellList.length + " " + spellText + " | Your Missing " + spellText + ": </h2>"));
					element.append(table); // Pet Result List
				});
			};
			
			$(document).ready(function(){ 
				// Enrich the g_spells array
				jQuery.each(gPetSpells, function(spellId, spell) {
					if ( !spell) 
						return;
					spell.id = spellId;
				});
				jQuery.each(gMountSpells, function(spellId, spell) {
					if ( !spell) 
						return;
					spell.id = spellId;
				});
				
				// Load cookie data
				$("#region").val($.cookie('pet_lister_region'));
				$("#charname").val($.cookie('pet_lister_char'));
				
				// Fetch initial realm list
				$("#region").change(function() {
					var sRegion = $(this).val();
					$("#realm").battlenet({action: 'fill-with-realms', region: sRegion, selected: $.cookie('pet_lister_realm')});
				}).change();
				
				// On Button Click
				$("#btn_scan").click(function() {
					var sRegion = $("#region").val();
					var sRealm = $("#realm").val();
					var sChar = $("#charname").val();
					var filterType = $("#list_id").val();
					
					// Store values in cookie for page reload
					$.cookie('pet_lister_region', sRegion);
					$.cookie('pet_lister_realm', sRealm);
					$.cookie('pet_lister_char', sChar);
					
					// Request the character data and parse the id list afterwards
					jQuery.battlenet({
						action: 'load-character-' + filterType,
						server: sRegion,
						realm: sRealm,
						charname: sChar,
						handler: function(character) {
							if (filterType == "companions") {
								$("#result_list").pet_lister(character.companions, character.race, gPetSpells);
							} else {
								$("#result_list").pet_lister(character.mounts, character.race, gMountSpells);
							}
							if ( window.$WowheadPower && $WowheadPower.init ) {
								$WowheadPower.init();
							}
						}
					});
					
					
				});
			});
		</script>
		
		<script type="text/javascript" src="http://static.wowhead.com/widgets/power.js"></script>
		<link rel="stylesheet" type="text/css" media="all" href="pet_lister.css">
	</head>
	<body>	
		<div id="page">
			<div id="header">
				<img id="mauer" src="http://ninjalooter.de/blog/wp-content/uploads/2010/08/Ninjalooter_Header_Mauer1.jpg" width="960" height="120" />
				<img id="logo" class="center" title="WoW Pet Lister" src="WPL_Banner.png" alt="" width="600" height="100" />
			</div>			
			<div id="nav" class="bar">
				Version 1.1
			</div>
			<div class="content">
				<h1>Charakter</h1>
				<div>
					<select id="region">
						<option value="eu.battle.net">EU</option>
						<option value="us.battle.net">US</option>
						<option value="kr.battle.net">KR</option>
						<option value="tw.battle.net">TW</option>
						<option value="battlenet.com.cn">CN</option>
					</select>
					<select id="realm">
						<option>Please wait</option>
					</select>
					<input type="text" id="charname" />
				</div>
				
				<h2>Filter</h2>
				<div>	
					<select id="list_id"><option value="companions">Pets</option><option value="mounts">Mounts</option></select><br />
					<input type="checkbox" value="true" id="filter_lootcards" checked="checked" /><label for="filter_lootcards">Hide Trading Card Game Pets</label>
					<input type="checkbox" value="true" id="filter_limited" checked="checked" /><label for="filter_limited">Hide Limited Editions</label><br />
					<input type="checkbox" value="true" id="filter_blizzcoll" checked="checked" /><label for="filter_blizzcoll">Hide Blizzard Collectables</label>
					<input type="checkbox" value="true" id="filter_blizzshop" checked="checked" /><label for="filter_blizzshop">Hide Blizzard Shop</label><br />
					
					<input type="checkbox" value="true" id="filter_ownfactionspells" /><label for="filter_ownfactionspells">Hide my faction</label>
					<input type="checkbox" value="true" id="filter_otherfactionspells" checked="checked" /><label for="filter_otherfactionspells">Hide other faction</label><br />
					
					<input type="checkbox" value="true" id="filter_classmounts" checked="checked" /><label for="filter_classmounts">Hide Class Mounts</label><br />
				</div>
				<div id="buttons">
					<button id="btn_scan"><img alt="Click to list your missing pets." title="Scan!" style="padding: 0pt 0px 0px 0pt;" src="scan_button4.png"/></button>
				</div>
				
			
				<div id="result_list">
				
				</div>
				
			</div>

			<div class="footer">
				Presented by <a href="http://ninjalooter.de/">Ninjalooter.de</a> | Database <a href="http://de.wowhead.com/">wowhead.com</a> | Characterdata from <a href="http://blizzard.github.com/api-wow-docs/">battle.net</a>
			</div>
		</div>
		
		<script type="text/javascript">//<![CDATA[
		var _gaq = _gaq || [];
 		_gaq.push(['_setAccount','UA-4347701-4']);
 		_gaq.push(['_trackPageview'],['_trackPageLoadTime']);
 		(function() {
  			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
 		})();
 		//]]></script>
	</body>
</html>
	
